<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Droplet ++ — Professional IDE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>

  <style>
    :root { --glass: rgba(15, 23, 42, 0.9); }
    * { font-family: 'Inter', sans-serif; }
    .mono { font-family: 'Fira Code', monospace; }
    body { background-color: #020617; overflow: hidden; height: 100vh; color: #e2e8f0; }
    .titlebar { background: linear-gradient(90deg, #6d28d9 0%, #db2777 100%); }
    .glass { background: var(--glass); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
    #editor { height: 100%; width: 100%; }
    .file-item.active { background: rgba(124, 58, 237, 0.2); border-left: 3px solid #a78bfa; }
    
    /* Media Preview Overlay */
    #mediaPreview { display: none; position: absolute; inset: 0; background: #0f172a; z-index: 20; align-items: center; justify-content: center; flex-direction: column; }
    
    /* Context Menu */
    #contextMenu { display: none; position: fixed; z-index: 1000; width: 150px; background: #1e293b; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.5); border-radius: 6px; padding: 4px; }
    .menu-item { padding: 8px 12px; font-size: 12px; cursor: pointer; border-radius: 4px; }
    .menu-item:hover { background: #4f46e5; }
  </style>
</head>
<body>

  <div id="contextMenu">
    <div class="menu-item" onclick="renameCurrentFile()">Rename</div>
    <div class="menu-item text-red-400" onclick="deleteCurrentFile()">Delete</div>
  </div>

  <div class="flex flex-col h-screen">
    <div class="titlebar h-10 flex items-center justify-between px-4 shadow-lg shrink-0">
      <div class="flex items-center gap-2">
        <div class="flex gap-1.5">
          <div class="w-3 h-3 rounded-full bg-red-400"></div>
          <div class="w-3 h-3 rounded-full bg-amber-400"></div>
          <div class="w-3 h-3 rounded-full bg-emerald-400"></div>
        </div>
        <span class="ml-4 text-xs font-bold tracking-widest uppercase">Droplet ++ IDE</span>
      </div>
      <div id="saveStatus" class="text-[10px] uppercase opacity-60">System Ready</div>
    </div>

    <div class="flex flex-1 overflow-hidden">
      <div class="w-64 glass flex flex-col shrink-0 border-r border-white/5">
        <div class="p-4 flex items-center justify-between border-b border-white/5">
          <span class="text-xs font-semibold uppercase text-slate-400">Explorer</span>
          <button id="newFileBtn" class="p-1 hover:bg-white/10 rounded"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"/></svg></button>
        </div>
        <div id="fileList" class="flex-1 overflow-y-auto py-2"></div>
      </div>

      <div class="flex-1 flex flex-col min-w-0">
        <div class="h-12 bg-slate-900/40 border-b border-white/5 flex items-center justify-between px-4">
          <div class="flex items-center gap-2">
            <button id="openFolderBtn" class="px-3 py-1.5 text-xs bg-slate-800 hover:bg-slate-700 rounded-md border border-white/5">Open Folder</button>
            <button id="saveFileBtn" class="px-3 py-1.5 text-xs bg-violet-600 hover:bg-violet-500 rounded-md">Save (Ctrl+S)</button>
          </div>
          <div class="flex items-center gap-3">
            <select id="previewSelect" class="bg-slate-800 text-xs border border-white/10 rounded px-2 py-1 outline-none"></select>
            <button id="togglePreviewBtn" class="p-2 hover:bg-white/10 rounded-full"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg></button>
          </div>
        </div>

        <div class="flex-1 relative">
          <div id="mediaPreview"></div>
          <div id="editor"></div>
        </div>

        <div class="h-8 bg-slate-950 border-t border-white/5 flex items-center justify-between px-4 text-[11px] text-slate-400">
          <div class="flex gap-4">
            <span id="posLabel">Ln 1, Col 1</span>
            <span id="fileLabel" class="text-violet-400">no_file.txt</span>
          </div>
          <span id="langLabel" class="uppercase font-medium text-violet-300">Plain Text</span>
        </div>
      </div>
    </div>
  </div>

  <div id="previewBubble" class="hidden fixed bottom-12 right-6 w-[450px] h-[350px] glass rounded-2xl shadow-2xl flex flex-col overflow-hidden z-40">
    <div class="h-10 bg-white/5 flex items-center justify-between px-4">
      <span class="text-[11px] font-bold uppercase tracking-widest opacity-70">Live Web View</span>
      <button id="closeBubble" class="text-lg opacity-50 hover:opacity-100">×</button>
    </div>
    <iframe id="bubbleFrame" class="w-full flex-1 bg-white" sandbox="allow-scripts allow-same-origin"></iframe>
  </div>

  <script>
    const State = {
      files: {}, // name: { content: string, isBinary: bool, blobUrl: string }
      activeFile: null,
      previewFile: null,
      folderHandle: null,
      rightClickedFile: null
    };

    let editor;

    /* --- INITIALIZATION --- */
    require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' }});
    require(['vs/editor/editor.main'], function () {
      editor = monaco.editor.create(document.getElementById('editor'), {
        theme: 'vs-dark',
        automaticLayout: true,
        fontFamily: 'Fira Code',
        minimap: { enabled: false }
      });

      editor.onDidChangeModelContent(() => {
        if (State.activeFile && !State.files[State.activeFile].isBinary) {
          State.files[State.activeFile].content = editor.getValue();
          document.getElementById('saveStatus').textContent = "Unsaved changes...";
        }
      });

      // Load Default VFS
      loadDefaults();
    });

    function loadDefaults() {
      State.files = {
        'index.html': { content: '<h1>Hello Droplet</h1>', isBinary: false },
        'styles.css': { content: 'body { background: #111; color: white; }', isBinary: false }
      };
      openFile('index.html');
      refreshFileList();
      syncPreviewDropdowns();
    }

    /* --- FILE SYSTEM LOGIC --- */
    function getExt(name) { return name.split('.').pop().toLowerCase(); }

    function isMedia(name) {
      return ['png', 'jpg', 'jpeg', 'gif', 'webp', 'mp3', 'wav', 'mp4', 'webm'].includes(getExt(name));
    }

    async function openFile(name) {
      if (!State.files[name]) return;
      State.activeFile = name;
      
      const fileData = State.files[name];
      const mediaContainer = document.getElementById('mediaPreview');
      const editorElement = document.getElementById('editor');

      if (fileData.isBinary) {
        // Show Media Preview
        editorElement.style.visibility = 'hidden';
        mediaContainer.style.display = 'flex';
        renderMedia(name, fileData);
      } else {
        // Show Code Editor
        editorElement.style.visibility = 'visible';
        mediaContainer.style.display = 'none';
        editor.setValue(fileData.content);
        monaco.editor.setModelLanguage(editor.getModel(), getLangFromExt(name));
      }

      document.getElementById('fileLabel').textContent = name;
      document.getElementById('langLabel').textContent = fileData.isBinary ? 'Media File' : getLangFromExt(name);
      refreshFileList();
    }

    function renderMedia(name, data) {
      const ext = getExt(name);
      const container = document.getElementById('mediaPreview');
      container.innerHTML = '';
      
      if (['png', 'jpg', 'jpeg', 'gif', 'webp'].includes(ext)) {
        container.innerHTML = `<img src="${data.blobUrl}" class="max-w-full max-h-full object-contain shadow-2xl">`;
      } else if (['mp4', 'webm'].includes(ext)) {
        container.innerHTML = `<video controls src="${data.blobUrl}" class="max-w-full max-h-full"></video>`;
      } else if (['mp3', 'wav'].includes(ext)) {
        container.innerHTML = `
          <div class="text-center">
            <div class="mb-4 text-violet-400">Audio Playback</div>
            <audio controls src="${data.blobUrl}"></audio>
          </div>`;
      }
    }

    function refreshFileList() {
      const list = document.getElementById('fileList');
      list.innerHTML = '';
      Object.keys(State.files).sort().forEach(name => {
        const div = document.createElement('div');
        div.className = `file-item px-4 py-2 text-xs cursor-pointer flex items-center gap-2 hover:bg-white/5 transition ${State.activeFile === name ? 'active' : ''}`;
        div.innerHTML = `<svg class="w-3 h-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg> <span>${name}</span>`;
        
        div.onclick = () => openFile(name);
        div.oncontextmenu = (e) => {
          e.preventDefault();
          showContextMenu(e, name);
        };
        list.appendChild(div);
      });
    }

    /* --- FOLDER ACCESS (CLEARS SIDEBAR) --- */
    document.getElementById('openFolderBtn').onclick = async () => {
      try {
        const handle = await window.showDirectoryPicker();
        State.folderHandle = handle;
        
        // CLEAR PREVIOUS STATE
        State.files = {};
        
        for await (const entry of handle.values()) {
          if (entry.kind === 'file') {
            const file = await entry.getFile();
            if (isMedia(entry.name)) {
              State.files[entry.name] = { 
                isBinary: true, 
                blobUrl: URL.createObjectURL(file) 
              };
            } else {
              State.files[entry.name] = { 
                isBinary: false, 
                content: await file.text() 
              };
            }
          }
        }
        
        const first = Object.keys(State.files)[0];
        if (first) openFile(first);
        refreshFileList();
        syncPreviewDropdowns();
        document.getElementById('saveStatus').textContent = "Folder Loaded";
      } catch(e) { console.warn("Picker closed"); }
    };

    /* --- CONTEXT MENU ACTIONS --- */
    const ctx = document.getElementById('contextMenu');
    function showContextMenu(e, filename) {
      State.rightClickedFile = filename;
      ctx.style.display = 'block';
      ctx.style.left = e.pageX + 'px';
      ctx.style.top = e.pageY + 'px';
    }

    window.onclick = () => ctx.style.display = 'none';

    window.renameCurrentFile = () => {
      const oldName = State.rightClickedFile;
      const newName = prompt("New filename:", oldName);
      if (newName && newName !== oldName) {
        State.files[newName] = State.files[oldName];
        delete State.files[oldName];
        if (State.activeFile === oldName) State.activeFile = newName;
        refreshFileList();
      }
    };

    window.deleteCurrentFile = () => {
      if (confirm(`Delete ${State.rightClickedFile}?`)) {
        delete State.files[State.rightClickedFile];
        if (State.activeFile === State.rightClickedFile) {
          State.activeFile = Object.keys(State.files)[0] || null;
          if (State.activeFile) openFile(State.activeFile);
        }
        refreshFileList();
      }
    };

    /* --- UTILS --- */
    function getLangFromExt(file) {
      const ext = getExt(file);
      const map = { js:'javascript', html:'html', css:'css', py:'python', json:'json', md:'markdown' };
      return map[ext] || 'plaintext';
    }

    function syncPreviewDropdowns() {
      const sel = document.getElementById('previewSelect');
      sel.innerHTML = '';
      Object.keys(State.files).forEach(name => {
        if (!State.files[name].isBinary) {
          const opt = document.createElement('option');
          opt.value = name; opt.textContent = name;
          sel.appendChild(opt);
        }
      });
    }

    document.getElementById('newFileBtn').onclick = () => {
      const name = prompt("Filename:");
      if (name) {
        State.files[name] = { content: "", isBinary: false };
        openFile(name);
        refreshFileList();
      }
    };

    // Toggle Preview Bubble
    document.getElementById('togglePreviewBtn').onclick = async () => {
      const bubble = document.getElementById('previewBubble');
      const frame = document.getElementById('bubbleFrame');
      bubble.classList.toggle('hidden');
      if (!bubble.classList.contains('hidden')) {
        const active = document.getElementById('previewSelect').value || State.activeFile;
        if (State.files[active]) frame.srcdoc = State.files[active].content;
      }
    };
    
    document.getElementById('closeBubble').onclick = () => document.getElementById('previewBubble').classList.add('hidden');
  </script>
</body>
</html>
