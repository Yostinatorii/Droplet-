<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Droplet ++ — Professional IDE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>

  <style>
    :root { --glass: rgba(15, 23, 42, 0.95); --accent: #7c3aed; }
    * { font-family: 'Inter', sans-serif; transition: background-color 0.2s; }
    body { background-color: #020617; overflow: hidden; height: 100vh; color: #e2e8f0; margin: 0; }
    .titlebar { background: linear-gradient(90deg, #6d28d9 0%, #db2777 100%); }
    .glass { background: var(--glass); backdrop-filter: blur(16px); border-right: 1px solid rgba(255,255,255,0.08); }
    #editor { height: 100%; width: 100%; }
    .file-item { border-left: 3px solid transparent; user-select: none; }
    .file-item:hover { background: rgba(255,255,255,0.05); }
    .file-item.active { background: rgba(124, 58, 237, 0.15); border-left: 3px solid var(--accent); color: white; }
    #mediaPreview { display: none; position: absolute; inset: 0; background: #0f172a; z-index: 20; align-items: center; justify-content: center; flex-direction: column; }
    #contextMenu { display: none; position: fixed; z-index: 1000; width: 170px; background: #1e293b; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 5px; box-shadow: 0 15px 30px rgba(0,0,0,0.6); }
    .menu-item { padding: 10px 14px; font-size: 12px; cursor: pointer; border-radius: 5px; display: flex; align-items: center; gap: 10px; }
    .menu-item:hover { background: var(--accent); color: white; }
    iframe { border: none; background: white; width: 100%; height: 100%; }
    .hidden { display: none !important; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
  </style>
</head>
<body>

  <div id="contextMenu">
    <div class="menu-item" onclick="renameCurrentFile()">Rename</div>
    <div class="menu-item text-red-400" onclick="deleteCurrentFile()">Delete</div>
  </div>

  <div class="flex flex-col h-screen">
    <header class="titlebar h-10 flex items-center justify-between px-4 shadow-xl shrink-0 z-50">
      <div class="flex items-center gap-3">
        <div class="flex gap-1.5"><div class="w-3 h-3 rounded-full bg-red-500"></div><div class="w-3 h-3 rounded-full bg-amber-500"></div><div class="w-3 h-3 rounded-full bg-emerald-500"></div></div>
        <span class="text-[11px] font-black tracking-[0.2em] uppercase text-white/90 ml-2">Droplet ++ IDE</span>
      </div>
      <div class="flex items-center gap-2">
        <span class="text-[9px] uppercase font-bold tracking-widest opacity-70">Folder Sync Mode</span>
      </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
      <aside class="w-64 glass flex flex-col shrink-0">
        <div class="p-4 flex items-center justify-between border-b border-white/5 bg-white/5">
          <span class="text-[10px] font-bold uppercase tracking-widest text-slate-400">Explorer</span>
          <button id="newFileBtn" class="p-1 hover:bg-white/10 rounded">＋</button>
        </div>
        <div id="fileList" class="flex-1 overflow-y-auto py-2"></div>
        <div class="p-4 border-t border-white/5 bg-black/20 flex flex-col gap-2">
            <button id="openFolderBtn" class="w-full py-2.5 bg-slate-800 hover:bg-slate-700 rounded-md text-[10px] font-bold uppercase transition border border-white/10 shadow-lg">Open Folder</button>
        </div>
      </aside>

      <main class="flex-1 flex flex-col min-w-0 bg-[#0b0f1a]">
        <div class="h-12 bg-slate-900/60 border-b border-white/5 flex items-center justify-between px-4">
          <div id="activeFileDisplay" class="text-xs font-mono text-violet-400 bg-violet-500/10 px-3 py-1 rounded-full border border-violet-500/20">no_file_selected</div>
          <div class="flex items-center gap-3">
            <div class="flex items-center bg-slate-800/80 rounded-lg p-1 border border-white/5">
               <span class="text-[9px] font-bold uppercase px-2 opacity-50">Preview Root:</span>
               <select id="previewSelect" class="bg-transparent text-[10px] text-violet-300 font-bold outline-none cursor-pointer pr-2"></select>
            </div>
            <button id="togglePreviewBtn" class="p-2 hover:bg-white/10 rounded-lg transition" title="Preview"><svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg></button>
            <button id="fullscreenBtn" class="p-2 hover:bg-white/10 rounded-lg transition" title="Fullscreen"><svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/></svg></button>
          </div>
        </div>

        <div class="flex-1 relative overflow-hidden">
          <div id="mediaPreview"></div>
          <div id="editor"></div>
        </div>

        <footer class="h-8 bg-[#020617] border-t border-white/5 flex items-center justify-between px-4 text-[10px] text-slate-500">
          <div class="flex gap-6 font-mono">
            <span id="posLabel">Ln 1, Col 1</span>
            <span id="fileLabel">idle</span>
          </div>
          <span id="langLabel" class="uppercase font-bold text-violet-400/80">N/A</span>
        </footer>
      </main>
    </div>
  </div>

  <div id="previewBubble" class="hidden fixed bottom-14 right-8 w-[480px] h-[360px] glass rounded-2xl shadow-2xl flex flex-col overflow-hidden z-[100] border border-white/10">
    <div class="h-11 bg-white/5 flex items-center justify-between px-4 border-b border-white/5">
      <span class="text-[10px] font-bold uppercase tracking-widest opacity-80">Live Viewport</span>
      <button id="closeBubble" class="text-lg opacity-40 hover:opacity-100">×</button>
    </div>
    <iframe id="bubbleFrame" sandbox="allow-scripts allow-same-origin"></iframe>
  </div>

  <div id="fullscreenPreview" class="hidden fixed inset-0 bg-slate-950 z-[200] flex flex-col">
    <div class="h-16 bg-slate-900 border-b border-white/10 flex items-center px-6 justify-between">
      <button id="backToEditor" class="text-sm font-bold hover:text-violet-400 transition flex items-center gap-2">← Back to Code</button>
      <select id="fullPreviewSelect" class="bg-slate-800 text-xs font-bold rounded px-4 py-2 border border-white/10 outline-none w-56 text-violet-300"></select>
    </div>
    <iframe id="fullFrame" sandbox="allow-scripts allow-same-origin"></iframe>
  </div>

  <script>
    const State = { files: {}, activeFile: null, previewFile: null, folderHandle: null, rightClickedFile: null };
    let editor;

    require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' }});
    require(['vs/editor/editor.main'], function () {
      editor = monaco.editor.create(document.getElementById('editor'), {
        theme: 'vs-dark', automaticLayout: true, fontFamily: 'Fira Code', fontSize: 13, minimap: { enabled: false }, links: false
      });

      editor.onDidChangeCursorPosition((e) => {
        document.getElementById('posLabel').textContent = `Ln ${e.position.lineNumber}, Col ${e.position.column}`;
      });

      editor.onDidChangeModelContent(() => {
        if (State.activeFile && !State.files[State.activeFile].isBinary) {
          State.files[State.activeFile].content = editor.getValue();
          updateLivePreviews();
        }
      });

      loadDefaults();
      initUI();
    });

    function loadDefaults() {
      State.files = { 'index.html': { content: '<h1>Drop or Open a Folder</h1>', isBinary: false } };
      State.previewFile = 'index.html';
      openFile('index.html');
      refreshFileList();
      syncPreviewDropdowns();
    }

    // UPDATED: Now clears everything and isolates folder contents
    document.getElementById('openFolderBtn').onclick = async () => {
      try {
        const handle = await window.showDirectoryPicker();
        State.folderHandle = handle;
        
        // 1. CLEAR CURRENT STATE
        State.files = {}; 
        State.previewFile = null;
        State.activeFile = null;
        
        // 2. READ NEW FOLDER
        for await (const entry of handle.values()) {
          if (entry.kind === 'file') {
            const file = await entry.getFile();
            const ext = entry.name.split('.').pop().toLowerCase();
            const isBin = ['png','jpg','jpeg','gif','webp','mp3','wav','mp4','webm'].includes(ext);
            
            if (isBin) {
              State.files[entry.name] = { isBinary: true, blobUrl: URL.createObjectURL(file) };
            } else {
              State.files[entry.name] = { isBinary: false, content: await file.text() };
            }
          }
        }

        // 3. AUTO-SELECT BEST FILE
        const files = Object.keys(State.files);
        if (files.length > 0) {
          const main = files.find(f => f === 'index.html') || files.find(f => f.endsWith('.html')) || files[0];
          openFile(main);
        }
        
        refreshFileList();
        syncPreviewDropdowns();
        updateLivePreviews();
      } catch (err) { console.warn("Access denied", err); }
    };

    function openFile(name) {
      if (!State.files[name]) return;
      if (State.activeFile && !State.files[State.activeFile].isBinary) {
        State.files[State.activeFile].content = editor.getValue();
      }
      
      State.activeFile = name;
      const data = State.files[name];
      const media = document.getElementById('mediaPreview');
      const editorDiv = document.getElementById('editor');

      if (data.isBinary) {
        editorDiv.style.visibility = 'hidden'; media.style.display = 'flex';
        renderMedia(name, data);
      } else {
        editorDiv.style.visibility = 'visible'; media.style.display = 'none';
        editor.setValue(data.content);
        monaco.editor.setModelLanguage(editor.getModel(), getLang(name));
      }
      
      if (name.endsWith('.html')) State.previewFile = name;
      document.getElementById('activeFileDisplay').textContent = name;
      document.getElementById('fileLabel').textContent = name;
      document.getElementById('langLabel').textContent = getLang(name).toUpperCase();
      
      refreshFileList();
      syncPreviewDropdowns();
    }

    function renderMedia(name, data) {
      const ext = name.split('.').pop().toLowerCase();
      const container = document.getElementById('mediaPreview');
      container.innerHTML = '';
      if (['png', 'jpg', 'jpeg', 'gif', 'webp'].includes(ext)) {
        container.innerHTML = `<img src="${data.blobUrl}" class="max-w-[85%] max-h-[85%] object-contain rounded-lg shadow-2xl border border-white/10">`;
      } else if (['mp4', 'webm'].includes(ext)) {
        container.innerHTML = `<video controls autoplay class="max-w-[85%] rounded-lg shadow-2xl"><source src="${data.blobUrl}"></video>`;
      } else if (['mp3', 'wav'].includes(ext)) {
        container.innerHTML = `<div class="p-8 bg-slate-800 rounded-2xl"><audio controls src="${data.blobUrl}"></audio></div>`;
      }
    }

    function refreshFileList() {
      const list = document.getElementById('fileList'); list.innerHTML = '';
      Object.keys(State.files).sort().forEach(name => {
        const div = document.createElement('div');
        div.className = `file-item px-4 py-2 text-xs cursor-pointer truncate ${State.activeFile === name ? 'active' : ''}`;
        div.textContent = name;
        div.onclick = () => openFile(name);
        div.oncontextmenu = (e) => { e.preventDefault(); State.rightClickedFile = name; const m = document.getElementById('contextMenu'); m.style.display='block'; m.style.left=e.pageX+'px'; m.style.top=e.pageY+'px'; };
        list.appendChild(div);
      });
    }

    function syncPreviewDropdowns() {
      const selects = [document.getElementById('previewSelect'), document.getElementById('fullPreviewSelect')];
      selects.forEach(sel => {
        sel.innerHTML = '';
        Object.keys(State.files).filter(f => f.endsWith('.html')).forEach(h => {
          const opt = document.createElement('option'); opt.value = h; opt.textContent = h;
          if (h === State.previewFile) opt.selected = true;
          sel.appendChild(opt);
        });
        sel.onchange = (e) => { State.previewFile = e.target.value; updateLivePreviews(); };
      });
    }

    function updateLivePreviews() {
      const target = State.files[State.previewFile];
      if (!target) return;
      document.getElementById('bubbleFrame').srcdoc = target.content;
      document.getElementById('fullFrame').srcdoc = target.content;
    }

    function initUI() {
      document.getElementById('togglePreviewBtn').onclick = () => document.getElementById('previewBubble').classList.toggle('hidden');
      document.getElementById('closeBubble').onclick = () => document.getElementById('previewBubble').classList.add('hidden');
      document.getElementById('fullscreenBtn').onclick = () => document.getElementById('fullscreenPreview').classList.remove('hidden');
      document.getElementById('backToEditor').onclick = () => document.getElementById('fullscreenPreview').classList.add('hidden');
      document.getElementById('newFileBtn').onclick = () => { const n = prompt("Filename:"); if(n) { State.files[n] = {content:"", isBinary:false}; refreshFileList(); openFile(n); }};
      window.onclick = () => document.getElementById('contextMenu').style.display='none';
    }

    window.renameCurrentFile = () => {
      const old = State.rightClickedFile; const n = prompt("Rename to:", old);
      if(n && n !== old) { State.files[n] = State.files[old]; delete State.files[old]; refreshFileList(); openFile(n); }
    };
    window.deleteCurrentFile = () => { if(confirm("Delete?")) { delete State.files[State.rightClickedFile]; openFile(Object.keys(State.files)[0]); refreshFileList(); } };

    function getLang(n) {
      const ext = n.split('.').pop().toLowerCase();
      const map = { js:'javascript', html:'html', css:'css', py:'python', json:'json', md:'markdown' };
      return map[ext] || 'plaintext';
    }
  </script>
</body>
</html>
